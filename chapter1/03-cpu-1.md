# CPU运行上下文的切换

CPU的上下文切换发生在这几个场景中：特权模式切换、进程上下文切换、线程上下文切换、中断上下文切换。

## 特权模式切换

在Linux中，特权模式切换也就是用户态和内核态的切换，一个用户态进程可以通过调用内核提供的系统调用进入到内核态，这个过程中有一些特殊的CPU指令会被执行，将CPU切换特权模式。

特权的模式的切换，一般是系统调用，通常是一去一回，伴随着两次上下文切换。

调用系统调用时候，需要保存进程在用户态的当前状态，然后切换到内核态代码，这是第一次上下文切换。

系统调用执行结束后，CPU退出特权模式，加载之前保留的用户态的状态，这是第二次上下文切换。

## 进程上下文切换

进程是内核管理调度的，是在内核态进行切换的。

进程上下文切换时，需要保留当前进程的状态，然后加载下一个继承的状态，每次切换需要几十纳秒到几微妙的时间，是一个开销非常大操作。

进程上下文切换后，一些存在硬件寄存器的缓存需要被重新刷新，也使执行效率受到影响。在多核的机器，进程还可能在不同CPU核心上移动，也会带来额外的开销。

进程上下文切换是一般不可避免的，因为在一个通用的Linux系统上，进程的数量一定是远远超过CPU核心数的。如果一个主要的工作进程因为被频繁地切换上下文，导致效率不高，可以将进程绑定指定CPU核心上。

## 线程上下文切换

进程是资源拥有的基本单位，线程是调度的基本单位。一个进程对应至少一个线程，可以对应多个线程。

隶属于同一个继承的线程间进行上下文切换的开销相对较小，因为它们有一部分共用的数据，这些数据可以免除切换。

## 中断上下文切换

中断通常是硬件发出的，也可以用实现“软中断”，中断发生后，CPU通常需要停下当前的工作，优先处理中断实现，指定中断事件对应的指令。

中断只发生在内核态。

中断会打断其它进程的调度和执行，带来额外的开销，如果中断次数过多，会显著降低整体系统。

## 用vmstat查看上下文切换

vmstat的输出如下（可以在后面加上一个数字，每隔指定时间输出一次，例如`vmstat 5`）：

```bash
$ vmstat
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 1  0   5980 126076    648 6997448    0    0     6    27   13    1  1  1 97  0  0
```

vmstat命令的输出包含`procs`、`memory`、 `swap`、`io`、`system`和`cpu`六块内容。

每列数据的含义如下，可以在`man vmstat`中找到：

	Procs
	    r: The number of runnable processes (running or waiting for run time).
	    b: The number of processes in uninterruptible sleep.
	
	Memory
	    swpd: the amount of virtual memory used.
	    free: the amount of idle memory.
	    buff: the amount of memory used as buffers.
	    cache: the amount of memory used as cache.
	    inact: the amount of inactive memory.  (-a option)
	    active: the amount of active memory.  (-a option)
	
	Swap
	    si: Amount of memory swapped in from disk (/s).
	    so: Amount of memory swapped to disk (/s).
	
	IO
	    bi: Blocks received from a block device (blocks/s).
	    bo: Blocks sent to a block device (blocks/s).
	
	System
	    in: The number of interrupts per second, including the clock.
	    cs: The number of context switches per second.
	
	CPU
	    These are percentages of total CPU time.
	    us: Time spent running non-kernel code.  (user time, including nice time)
	    sy: Time spent running kernel code.  (system time)
	    id: Time spent idle.  Prior to Linux 2.5.41, this includes IO-wait time.
	    wa: Time spent waiting for IO.  Prior to Linux 2.5.41, included in idle.
	    st: Time stolen from a virtual machine.  Prior to Linux 2.6.11, unknown.

其中`cs`是一秒内发生的上下文切换次数。
