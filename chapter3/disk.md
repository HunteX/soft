<!-- toc -->
# 磁盘相关知识

机械磁盘，通常缩写为HDD，机械磁盘有磁道寻址的时间，随机读写是性能会变差。

固态磁盘，通常缩写为SSD，不需要寻道，随机读写和连续读写效率均较高。

磁盘接口主要有：IDE、SCSI、SAS、SATA、FC等。

在具体使用的时候，可以将磁盘作为独立磁盘用，在每个磁盘上划分逻辑分区，或者将多个独立磁盘组合成一个逻辑磁盘，譬如RAID，RAID分为RAID0、RAID1、RAID5、RAID10，或者将磁盘组合成一个存储集群，通过NFS、SMB、iSCSI等网络存储协议接入服务器。

磁盘被Linux认作是块设备，拥有主设备号和次设备号，主设备号用于区分设备类型，面向驱动程序，次设备号是同类设备的唯一编号。

## 磁盘数据最小读取单位

机械磁盘的最小读取单位是扇区，每个扇区一般为512字节。

固态磁盘的最小读取单位是页，通常是4KB、8KB。

## 磁盘数据最小管理单位

逻辑块是磁盘上连续的扇区或者页，逻辑块是磁盘数据的最小管理单位。

## 磁盘性能指标

**使用率**：磁盘处理I/O的时间占比，使用率过高超过80%，说明磁盘I/O存在性能瓶颈。

**饱和度**：磁盘处理I/O的繁忙程度，饱和度为100%时，磁盘已经无法接收新的I/O请求。

**IOPS**：每秒钟的I/O操作次数。

**吞吐量**：每秒的数据吞吐量。

**响应时间**：I/O请求发出与收到响应的间隔时间。

磁盘使用率高不等于磁盘饱和，如果每次I/O操作的数据量很少，磁盘的使用率高，但是饱和度不高，可以继续接收新的I/O请求。(感觉饱和度有点类似于带宽占比，是和吞吐量相关的)

## 磁盘性能测试工具

fio，测试时需要考虑不同I/O大小、随机读、顺序读、随机写、顺序写等。

## 磁盘状态观测

iostat，呈现的数据来自`/proc/diskstats`，`-d -x` 显示所有磁盘 I/O 的指标。

```sh
# iostat -d -x 1
Device:    rrqm/s   wrqm/s     r/s     w/s    rkB/s    wkB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util
vda          0.00     0.01    0.43    0.19    74.76     1.59   243.28     0.06    4.63    1.67   11.27  97.45   6.12
vdb          0.00     0.00    0.72    0.01   146.07     0.19   402.12     0.00    1.43    1.26   11.25   0.15   0.01

Device:    rrqm/s   wrqm/s     r/s     w/s    rkB/s    wkB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util
vda          0.00     0.00    1.00    0.00     8.00     0.00    16.00     0.00    4.00    4.00    0.00   4.00   0.40
vdb          0.00     0.00    0.00    0.00     0.00     0.00     0.00     0.00    0.00    0.00    0.00   0.00   0.00

Device:    rrqm/s   wrqm/s     r/s     w/s    rkB/s    wkB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util
vda          0.00     0.00    0.00    0.00     0.00     0.00     0.00     0.00    0.00    0.00    0.00   0.00   0.00
vdb          0.00     0.00    0.00    0.00     0.00     0.00     0.00     0.00    0.00    0.00    0.00   0.00   0.00
```

```txt
rrqm/s： 每秒合并读请求数  r/s：每秒发送给磁盘的读请求数（合并后） rkB/s：每秒从磁盘读取的数据量，单位KB   r_await： 读响应时间

wrqm/s： 合并写请求速率    w/s：每秒发送给磁盘的写请求数（合并后） wkB/s：每秒向磁盘写入的数据量，单位KB   w_await：写响应时间

avgqu-sz/aqu-sz：平均请求队列长度

svctm： 推断的处理I/O请求需要的平均时间，单位是毫秒

%util：磁盘处理I/O的时间占比，即使用率，使用率100%，说明I/O操作多，不等于磁盘饱和
```
